{% load widget_tweaks %}
{% load maintags %}

{% with 'Stage_'|concat:stage_num as oStage %}
<input type="hidden" id="{{oStage}}_SectionsCount" name="{{oStage}}_sections_count" value="{% if stage.sections|length > 0 %}{{ stage.sections|length }}{% else %}1{% endif %}">

<div class="panel mt-4" id="{{ oStage }}_Stage">
    <div class="panel-header mb-2">
        <h4 class="modal-title">Stage {{ stage_num }}</h4>
    </div>

    <div class="panel-body">
        <div class="row" id="{{ oStage }}_SectionsList">
        {% for section in stage.sections %}
            {% include 'main/rally_edit_stage_section.html' with stage_num=stage_num section_num=forloop.counter section=section %}
        {% empty %}
            {% include 'main/rally_edit_stage_section.html' with stage_num=stage_num section_num=1 %}
        {% endfor %}
        </div>
    </div>

    <div class="panel-footer">
        <div class="form-inline">
            <a href="#" class="btn btn-primary" onclick="_o{{oStage}}.addSection()">Add section</a>

            <div class="input-group ml-3">
                <div class="input-group-text">
                    <input type="checkbox" id="{{oStage}}_has_assistance" name="{{oStage}}_has_assistance" title="Set assistance">
                </div>
                <div class="input-group-append">
                    <label class="input-group-text" for="{{oStage}}_has_assistance">Ends with assistance</label>
                    <a class="btn btn-secondary" href="#"
                       data-toggle="tooltip" data-html="true"
                       title="<h1>Ends with assistance</h1>
                            <p>Check this option if you want to allow an assistance at the end of this stage.
                                <br />Players will be able to repair their car before the next stage.</p>
                            <p>Otherwise, players will go directly to the next stage without any repair possibility.</p>"
                    >
                        <i class="fas fa-question-circle"></i>
                    </a>
                </div>
            </div>


            {% if stage_num != 1 %}<!-- Avoid removeStageBtn for first stage because this stage is mandatory -->
            <div class="input-group ml-3">
                <a id="{{ oStage }}_removeStageBtnUnsaved" class="btn btn-warning mr-3" href="#"
                   data-toggle="tooltip" data-html="true"
                   data-title="You must <strong>Save the roadbook</strong> in order to preserve the configuration of this stage, otherwise it will be lost if you <strong>Remove unsaved stages</strong>"
                   style="display: none"
                >
                    <i class="fas fa-exclamation-triangle"></i> Unsaved stage
                </a>
                <a id="{{ oStage }}_removeStageBtn" class="btn btn-danger" href="#"
                   onclick="stageEditor.removeStage({{ stage_num }})"
                   style="display: none"
                >
                    <i class="fas fa-trash-alt"></i> <span id="{{ oStage }}_removeStageBtnLabel">Remove stage</span>
                </a>

                <div class="input-group-append">
                    <a id="{{ oStage }}_removeStageBtnUnsavedHelp" class="btn btn-secondary" href="#"
                       data-toggle="tooltip" data-html="true"
                       title="<h1>Remove unsaved stages</h1>
                            <p>Removes unsaved stages from the roadbook.</p>
                            <p>All stages that has not been saved yet will be removed from the roadbook.</p>"
                       style="display: none"
                    >
                        <i class="fas fa-question-circle"></i>
                    </a>
                    <a id="{{ oStage }}_removeStageBtnHelp" class="btn btn-secondary" href="#"
                       data-toggle="tooltip" data-html="true"
                       title="<h1>Remove last stage</h1>
                            <p>Removes <strong>Stage {{ stage_num }}</strong> from the roadbook.</p>"
                       style="display: none"
                    >
                        <i class="fas fa-question-circle"></i>
                    </a>
                </div>

            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>

    var _o{{oStage}} = Object();
    _o{{oStage}}.sectionsCount = $('#{{oStage}}_SectionsCount');
    _o{{oStage}}.sectionsList = $('#Stage_{{ stage_num }}_SectionsList');

    _o{{oStage}}.addSection = function() {
        let _lp = '_o{{oStage}}.addSection: ';
        let url = '{% url 'rally-edit-add-section' pk=rally.id stage_num=stage_num %}';
        url += '?section_num=' + (parseInt(_o{{oStage}}.sectionsCount.val()) + 1);
        $.ajax({
            url: url,
            success: function(data, status, xhr) {
                _o{{oStage}}.sectionsList.html(_o{{oStage}}.sectionsList.html() + data);
                $('#{{ oStage }}_' + _o{{oStage}}.sectionsCount.val() + '_removeBtn').hide();
                _o{{oStage}}.sectionsCount.val(parseInt(_o{{oStage}}.sectionsCount.val()) + 1);
            },
            error: function(xhr, status, data) {
                console.log(_lp+' ' + xhr.status + 'Error while calling url : ' + url + ' : ' + data);
            }
        })
    };

    _o{{oStage}}.removeSection = function(section_num) {
        let _sectionName = '#Stage_{{ stage_num }}_' + section_num;
        $(_sectionName).remove();
        _o{{oStage}}.sectionsCount.val(parseInt(_o{{oStage}}.sectionsCount.val()) - 1);
        $('#{{ oStage }}_' + _o{{oStage}}.sectionsCount.val() + '_removeBtn').show();
    };

    $(document).ready(function() {

        if (parseInt({{ stage_num }}) > stageEditor.stagesListSaved) {
            $('#Stage_{{ stage_num }}_removeStageBtnUnsaved').show();
        }

        if (parseInt(stageEditor.stagesCount.val()) !== parseInt(stageEditor.stagesListSaved)) {
            $('#{{ oStage }}_removeStageBtnLabel').html('Remove unsaved stages');
        }

        if (parseInt({{ stage_num }}) === parseInt(stageEditor.stagesCount.val())) {

            if (parseInt(stageEditor.stagesCount.val()) > parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsaved').show();
                $('#{{ oStage }}_removeStageBtn').hide();
            }
            else if (parseInt(stageEditor.stagesCount.val()) === parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsaved').hide();
                $('#{{ oStage }}_removeStageBtn').show();
            }

        }

        if (parseInt({{ stage_num }}) === parseInt(stageEditor.stagesCount.val())) {
            if (parseInt(stageEditor.stagesCount.val()) > parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsaved').show();
                $('#{{ oStage }}_removeStageBtn').hide();
            }
            else if (parseInt(stageEditor.stagesCount.val()) === parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsaved').hide();
                $('#{{ oStage }}_removeStageBtn').show();
            }
        }
        if (parseInt({{ stage_num }}) === parseInt(stageEditor.stagesCount.val())) {
            $('#{{ oStage }}_removeStageBtn').show();
        }

        if (parseInt({{ stage_num }}) === parseInt(stageEditor.stagesCount.val())) {
            if (parseInt(stageEditor.stagesCount.val()) > parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsavedHelp').show();
                $('#{{ oStage }}_removeStageBtnHelp').hide();
            }
            else if (parseInt(stageEditor.stagesCount.val()) === parseInt(stageEditor.stagesListSaved)) {
                $('#{{ oStage }}_removeStageBtnUnsavedHelp').hide();
                $('#{{ oStage }}_removeStageBtnHelp').show();
            }
        }

        $('[data-toggle="tooltip"]').tooltip();

    });

</script>

{% endwith %}
