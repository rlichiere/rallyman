{% extends 'main/base.html' %}
{% load widget_tweaks %}

{% block page-header %}Lobby{% endblock %}

{% block page-body %}

<style>
    .rallies-list {
        margin-bottom: 15px;
    }
    .rallies-list td, .rallies-list th {
        text-align: center;
    }

    .rallies-list > table {
        margin-top: 7px;
    }
    .rallies-list th.orderable {
        cursor: pointer;
    }

    .rallies-list-tooltip p {
        text-align: left;
    }

    #btnReset {
        display: none;
        margin-left: 7px
    }
    #btnRefresh {
        margin-left: 7px
    }

    #formFilter label {
        margin-right: 5px;
    }
</style>

<div class="row">

    <!-- Filter -->
    <div class="col-lg-12 mb-4">
        <form class="form-inline" method="get" action="{% url 'main-lobby' %}" id="formFilter">
            Filter by:
            <div class="form-group ml-4">
                <label for="{{ form_filter.rly_stat.id_for_label }}">Rally status</label>
                {% render_field form_filter.rly_stat class+='form-control' %}
            </div>

            {% if not user.is_anonymous %}
            <div class="form-group ml-4">
                <label for="{{ form_filter.usr_part.id_for_label }}">Rallies I participate in</label>
                {% render_field form_filter.usr_part class+='form-control' %}
            </div>
            {% endif %}

            {% if not user.is_anonymous %}
            <div class="form-group ml-4">
                <label for="{{ form_filter.rly_crea.id_for_label }}">Rally creator</label>
                {% render_field form_filter.rly_crea class+='form-control' %}
            </div>
            {% endif %}

            <button id="btnRefresh" type="submit" class="btn btn-primary ml-4">Refresh</button>
            <button id="btnReset" class="btn btn-warning">Reset</button>

            <div style="display:none;">
                {% render_field form_filter.ord_b %}
                {% render_field form_filter.ord_w %}
            </div>
        </form>
    </div>

    <!-- Pagination : number of items in page -->
    <div class="col-lg-12 mb-1">
        <div style="display:inline-block">
            Show
        </div>
        <div style="display:inline-block">
            {% render_field form_pgps.available_page_sizes class='form-control' %}
        </div>
        <div style="display:inline-block">
            rallies
        </div>
        <div style="display:none;">
            {% render_field form_pgps.selected_page_size class="form-control" %}
        </div>
    </div>

    <!-- List -->
    <div class="rallies-list col-lg-12">
        <table class="table table-sm" style="display: table">
        <thead>
            <tr>
                <th class="orderable" onclick="orderByColumnClicked('label');">Rally name</th>
                <th>Number of participants</th>
                <th>Number of stages</th>
                <th class="orderable" onclick="orderByColumnClicked('status');">Rally status</th>
                <th class="orderable" onclick="orderByColumnClicked('creator');">Creator of the rally</th>
                <th class="orderable" onclick="orderByColumnClicked('created_at');">Rally created at</th>
                <th class="orderable" onclick="orderByColumnClicked('opened_at');">Rally opens at</th>

                {% if not user.is_anonymous %}
                <th>Action</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
        {% for rally in rallies %}
            <tr>
                <td>{{ rally.label }}</td>
                <td>
                    <a href="#" class="btn btn-secondary"
                    {% if rally.participants_count > 0 %}
                        data-toggle="tooltip" data-html="true"
                        data-title="<div class='rallies-list-tooltip'>
                                        <h5>Participants</h5>
                                        <p>
                                        {% for part in rally.participants %}
                                            {{ part.player }}<br />
                                        {% endfor %}
                                        </p>
                                    </div>"
                    {% endif %}
                    >
                        {{ rally.participants_count }}
                    </a>
                </td>
                <td>
                    <a href="#" class="btn btn-secondary"
                    {% if rally.stages_count > 0 %}
                        data-toggle="tooltip" data-html="true"
                        data-title="<div class='rallies-list-tooltip'>
                                        <h5>Stages</h5>
                                        <p>
                                        {% for stage in rally.stages %}
                                            <strong>SS {{ forloop.counter }}</strong>: {{ stage.roadbook_as_label }}
                                            <br />
                                        {% endfor %}
                                        </p>
                                    </div>"
                    {% endif %}
                    >
                        {{ rally.stages_count }}
                    </a>
                </td>
                <td>{{ rally.status|lower|capfirst }}</td>
                <td>{{ rally.creator.get_full_name }}</td>
                <td>{{ rally.created_at }}</td>
                <td>{{ rally.opened_at }}</td>

                {% if not user.is_anonymous %}
                <td>
                    {% if rally.is_joignable %}
                    <a id="btnJoinModal_{{ rally.id }}" href="{% url 'rally-register' pk=rally.id %}" class="btn btn-primary"
                        data-toggle="modal" data-target="#GenericModal">
                        <i class="far fa-calendar-plus"></i> Join
                    </a>
                    {% endif %}

                    {% if rally.is_quitable %}
                    <a id="btnQuitModal_{{ rally.id }}" href="{% url 'rally-unregister' pk=rally.id %}" class="btn btn-primary"
                        data-toggle="modal" data-target="#GenericModal">
                        <i class="far fa-calendar-minus"></i> Quit
                    </a>

                    {% endif %}
                </td>
                {% endif %}

            </tr>
        {% empty %}
            <tr><td colspan="5">You don't have a rally in progress.</td></tr>
        {% endfor %}
        </tbody>
        </table>

        <!-- Pagination navigation  -->
        <div class="float-sm-right">
            <ul class="pagination ">
            {% if rallies.number > 1 %}
            {% if has_filter %}
                <li class="page-item"><a class="page-link" href="{{ page_url }}&_pgpi={{ rallies.previous_page_number }}">&laquo;</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ page_url }}?_pgpi={{ rallies.previous_page_number }}">&laquo;</a></li>
            {% endif %}
            {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">&laquo;</a></li>
            {% endif %}

            {% for page_button in pages_list %}
            {% if page_button == 0 %}
                <li class="paginate_button disabled">
                    <a href="#">â€¦</a>
                </li>
            {% else %}
                <li class="page-item {% if page_button == rallies.number %} active{% endif %}"
                    tabindex="{{ page_button }}">
                    {% if has_filter %}
                        <a class="page-link" href="{{ page_url }}&_pgpi={{ page_button }}">{{ page_button }}</a>
                    {% else %}
                        <a class="page-link" href="{{ page_url }}?_pgpi={{ page_button }}">{{ page_button }}</a>
                    {% endif %}
                </li>
            {% endif %}
            {% endfor %}

            {% if rallies.number < rallies.paginator.num_pages %}
            {% if has_filter %}
                <li class="page-item"><a class="page-link" href="{{ page_url }}&_pgpi={{ rallies.next_page_number }}">&raquo;</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ page_url }}?_pgpi={{ rallies.next_page_number }}">&raquo;</a></li>
            {% endif %}
            {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">&raquo;</a></li>
            {% endif %}
            </ul>
        </div>

        <a id="btnCreateModal" href="{% url 'rally-create' %}" class="btn btn-primary" data-toggle="modal" data-target="#GenericModal">
            <i class="far fa-plus-square"></i> Create Rally
        </a>
    </div>

</div>

<script>

    let elem_tenant_by_page = $('#available_page_sizes');
    elem_tenant_by_page.change(function() {
        let tenant_per_page = elem_tenant_by_page[0].value;
        $('#show_number_tenant').val(tenant_per_page);
        sendFilterForm();
    });
    function sendFilterForm() {
        $('input').each(function() {
            if($(this).val() === '') {
                $(this).remove();
            }
        });
        $('select').each(function() {
            if($(this).val() === '') {
                $(this).remove();
            }
        });
        $('#filter_form').submit();
    }

    let btnReset = $('#formFilter #btnReset');
    let inputFilterUserParticipation = $('#{{ form_filter.usr_part.id_for_label }}');
    let inputFilterRallyStatus = $('#{{ form_filter.rly_stat.id_for_label }}');
    let inputFilterRallyCreator = $('#{{ form_filter.rly_crea.id_for_label }}');
    let formFilter = $('#formFilter');
    let inputOrderBy = $('#{{ form_filter.ord_b.id_for_label }}');
    let inputOrderWay = $('#{{ form_filter.ord_w.id_for_label }}');

    let btnCreateModal = $('#btnCreateModal');

    function orderByColumnClicked(column_name) {
        inputOrderBy.val(column_name);

        if (inputOrderWay.val() === 'd') {
            inputOrderWay.val('a');
        } else {
            inputOrderWay.val('d');
        }
        formFilter.submit();
    }

    function isResetRequired() {
        {% if not user.is_anonymous %}
        if ((inputFilterRallyStatus.val() !== '')
            || (inputFilterUserParticipation.val() !== '')
            || (inputFilterRallyCreator.val() !== '')) {
            return true;
        }
        {% else %}
        if (inputFilterRallyStatus.val() !== '') {
            return true;
        }
        {% endif %}
    }

    function loadElementContentFromUrl(elem_id, url) {
        let elem = $('#' + elem_id);
        elem.html('');
        $.ajax({
            url: url,
            success: function(data, status, xhr) {
                elem.html(data);
            },
            error: function(xhr, status, data) {
                elem.html(data);
            }
        });
    }

    $(document).ready(function() {

        inputFilterUserParticipation.change(function() {
            btnReset.show();
        });
        inputFilterRallyStatus.change(function() {
            btnReset.show();
        });
        inputFilterRallyCreator.change(function() {
            btnReset.show();
        });

        btnReset.click(function() {
            inputFilterUserParticipation.val('');
            inputFilterRallyStatus.val('');
            inputFilterRallyCreator.val('');
            formFilter.submit();
        });

        btnCreateModal.click(function() {
            loadElementContentFromUrl('GenericModalContent', $(this).prop('href'));
        });

        {% if not user.is_anonymous %}
        {% for rally in rallies %}

        {% if rally.is_joignable %}
        let btnJoinModal_{{ rally.id }} = $('#btnJoinModal_{{ rally.id }}');
        btnJoinModal_{{ rally.id }}.click(function() {
            loadElementContentFromUrl('GenericModalContent', $(this).prop('href'));
        });
        {% endif %}

        {% if rally.is_quitable %}
        let btnQuitModal_{{ rally.id }} = $('#btnQuitModal_{{ rally.id }}');
        btnQuitModal_{{ rally.id }}.click(function() {
            loadElementContentFromUrl('GenericModalContent', $(this).prop('href'));
        });
        {% endif %}

        {% endfor %}
        {% endif %}


        if (isResetRequired()) {
            btnReset.show();
        }

    });

</script>

{% endblock %}
